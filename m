Return-path: <linux-media-owner@vger.kernel.org>
Received: from mail-oi0-f54.google.com ([209.85.218.54]:40420 "EHLO
        mail-oi0-f54.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S932566AbeCMK5C (ORCPT
        <rfc822;linux-media@vger.kernel.org>);
        Tue, 13 Mar 2018 06:57:02 -0400
Received: by mail-oi0-f54.google.com with SMTP id c12so14908057oic.7
        for <linux-media@vger.kernel.org>; Tue, 13 Mar 2018 03:57:02 -0700 (PDT)
MIME-Version: 1.0
In-Reply-To: <c18549be-d55e-54d2-1524-1c51d05807ec@by.com.es>
References: <c18549be-d55e-54d2-1524-1c51d05807ec@by.com.es>
From: Fabio Estevam <festevam@gmail.com>
Date: Tue, 13 Mar 2018 07:57:01 -0300
Message-ID: <CAOMZO5DShsQxe2yTTmKo=v+jN_OzASGzSct=7hrbvky9T+TgdA@mail.gmail.com>
Subject: Re: coda: i.MX6 decoding performance issues for multi-streaming
To: Javier Martin <javiermartin@by.com.es>
Cc: linux-media <linux-media@vger.kernel.org>,
        Philipp Zabel <p.zabel@pengutronix.de>
Content-Type: text/plain; charset="UTF-8"
Sender: linux-media-owner@vger.kernel.org
List-ID: <linux-media.vger.kernel.org>

Hi Javier,

On Mon, Mar 12, 2018 at 1:54 PM, Javier Martin <javiermartin@by.com.es> wrote:
> Hi,
> we have an i.MX6 Solo based board running the latest mainline kernel
> (4.15.3).
>
> As part of our development we were measuring the decoding performance of the
> i.MX6 coda chip.
>
> For that purpose we are feeding the decoder with 640x368 @ 30fps H.264
> streams that have been generated by another i.MX6 coda encoder configured
> with fixed qp = 25 and gopsize = 16.
>
> For 1-2 streams it works smoothly. However, when adding the 3rd stream the
> first decoder instance starts to output these kind of errors:
>
> DEC_PIC_SUCCESS = 2097153  -> 0x200001
> DEC_PIC_SUCCESS = 2621441  -> 0x280001
>
> Every time one of these errors appears we can observe a weird artifact in
> the decoded video (pixelated macroblocks and/or jumps back in time).
>
> I tried looking at the original VPU lib implementation by Freescale [1] but
> they don't seem to handle these errors either. As I don't have access to any
> kind of Coda IP documentation it's quite hard to me to perform any
> additional debugging.
>
> Has anyone experienced these kind of performance issues too? I'm open to any
> suggestions and willing to perform extra tests to get to the bottom of this.

Are you passing 'capture-io-mode=dmabuf' in your Gstreamer pipeline?

This really improves the performance of video decoding.
