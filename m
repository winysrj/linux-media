Return-path: <linux-media-owner@vger.kernel.org>
Received: from mail-out-4.itc.rwth-aachen.de ([134.130.5.49]:27745 "EHLO
        mail-out-4.itc.rwth-aachen.de" rhost-flags-OK-OK-OK-OK)
        by vger.kernel.org with ESMTP id S1751700AbeCNUtt (ORCPT
        <rfc822;linux-media@vger.kernel.org>);
        Wed, 14 Mar 2018 16:49:49 -0400
To: <linux-usb@vger.kernel.org>
CC: Laurent Pinchart <Laurent.pinchart@ideasonboard.com>,
        <linux-media@vger.kernel.org>, Felipe Balbi <balbi@kernel.org>
From: Joel Pepper <joel.pepper@rwth-aachen.de>
Subject: uvc-gadget created with configfs sets all bFrameIndex to 1
Message-ID: <87c86102-d235-b489-b235-a1ec9ad7ba30@rwth-aachen.de>
Date: Wed, 14 Mar 2018 21:40:04 +0100
MIME-Version: 1.0
Content-Type: multipart/mixed;
        boundary="------------02BFF3355F66597395B60FB9"
Content-Language: en-US
Sender: linux-media-owner@vger.kernel.org
List-ID: <linux-media.vger.kernel.org>

--------------02BFF3355F66597395B60FB9
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: quoted-printable

I am currently working on an application for my master thesis that does
transparent inline modification of  frames received from a uvc webcam
which are served to the actual host through a uvc gadget mimicking the
underlying webcam. I recently noticed that the host side v4l2 driver
would only ever request bFrameIndex 1, no matter the requested format.


So I used usbmon to take a closer look (pcap is attached ). Take a look
at the Video Streaming interface descriptor in packet no. 6: All 19
different framesizes have their bFrameIndex set to 1. This makes
requesting any framesize but the actual first one impossible.


I took a quick look at drivers/usb/gadget/function/uvc_configfs.c and
noticed that the bFrameIndex attribute of a frame is set to 1 per
default in "uvcg_frame_make"**, but the attribute is neither made
accessible through configfs nor could I see any mechanism by which the
indices are set automatically.


As I am new to kernel development, I wanted ask for comment first before
I start brewing up a possible patch for this bug. Currently I see three
solutions:

1) Expose bFrameIndex through ConfigFs, to be set by the user

2) Assign an unused bFrameIndex during "uvcg_frame_make"

3) Once framesizes of a format are finalized, iterate through frames and
assign ascending indices


There is also obviously the possibility that I gravely misconfigured my
gadget through configfs, if so please point me in the right direction.


Regards,

Joel


--------------02BFF3355F66597395B60FB9
Content-Type: application/x-pcapng; name="bFrameIndex_bug.pcapng"
Content-Transfer-Encoding: base64
Content-Disposition: attachment; filename="bFrameIndex_bug.pcapng"

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
--------------02BFF3355F66597395B60FB9--
