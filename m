Return-path: <linux-media-owner@vger.kernel.org>
Received: from mail-fx0-f168.google.com ([209.85.220.168]:46628 "EHLO
	mail-fx0-f168.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1751963AbZEWOE4 (ORCPT
	<rfc822;linux-media@vger.kernel.org>);
	Sat, 23 May 2009 10:04:56 -0400
Received: by fxm12 with SMTP id 12so388260fxm.37
        for <linux-media@vger.kernel.org>; Sat, 23 May 2009 07:04:56 -0700 (PDT)
MIME-Version: 1.0
Date: Sat, 23 May 2009 16:04:55 +0200
Message-ID: <d9def9db0905230704n4f8b725aj3dc3021187d5ae12@mail.gmail.com>
Subject: [PATCH] em28xx device mode detection based on endpoints
From: Markus Rechberger <mrechberger@gmail.com>
To: linux-media@vger.kernel.org
Content-Type: multipart/mixed; boundary=0016e6587a0c9d470f046a94dc6a
Sender: linux-media-owner@vger.kernel.org
List-ID: <linux-media.vger.kernel.org>

--0016e6587a0c9d470f046a94dc6a
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit

Hi,

for em28xx devices the device node detection can be based on the
encoded endpoint address, for example EP 0x81 (USB IN, Interrupt),
0x82 (analog video EP), 0x83 (analog audio ep), 0x84 (mpeg-ts input
EP).
It is not necessary that digital TV devices have a frontend, the
em28xx chip only specifies an MPEG-TS input EP.

Following patch adds a check based on the Endpoints, although it might
be extended that all devices match the possible devicenodes based on
the endpoints, currently the driver registers an analog TV node by
default for all unknown devices which is not necessarily correct, this
patch disables the ATV node if no analog TV endpoint is available.

best regards,
Markus

--0016e6587a0c9d470f046a94dc6a
Content-Type: text/x-diff; charset=US-ASCII; name="em28xx_ep_nodedetection.diff"
Content-Disposition: attachment; filename="em28xx_ep_nodedetection.diff"
Content-Transfer-Encoding: base64
X-Attachment-Id: f_fv2e4pam0

ZGlmZiAtciAzMTViYzRiNjViNGYgbGludXgvZHJpdmVycy9tZWRpYS92aWRlby9lbTI4eHgvZW0y
OHh4LWNhcmRzLmMKLS0tIGEvbGludXgvZHJpdmVycy9tZWRpYS92aWRlby9lbTI4eHgvZW0yOHh4
LWNhcmRzLmMJU3VuIE1heSAxNyAxMjoyODo1NSAyMDA5ICswMDAwCisrKyBiL2xpbnV4L2RyaXZl
cnMvbWVkaWEvdmlkZW8vZW0yOHh4L2VtMjh4eC1jYXJkcy5jCVNhdCBNYXkgMjMgMTY6MDM6Mzkg
MjAwOSArMDIwMApAQCAtMTU5Niw5ICsxNTk2LDEzIEBACiAvKiBTaW5jZSBlbTI4eHhfcHJlX2Nh
cmRfc2V0dXAoKSByZXF1aXJlcyBhIHByb3BlciBkZXYtPm1vZGVsLAogICogdGhpcyB3b24ndCB3
b3JrIGZvciBib2FyZHMgd2l0aCBnZW5lcmljIFBDSSBJRHMKICAqLwotdm9pZCBlbTI4eHhfcHJl
X2NhcmRfc2V0dXAoc3RydWN0IGVtMjh4eCAqZGV2KQorc3RhdGljIGludCBlbTI4eHhfcHJlX2Nh
cmRfc2V0dXAoc3RydWN0IGVtMjh4eCAqZGV2LAorCQkJCXN0cnVjdCB1c2JfaW50ZXJmYWNlICpp
bnRmKQogewogCWludCByYzsKKwlpbnQgaTsKKwlzdHJ1Y3QgdXNiX2hvc3RfaW50ZXJmYWNlICpo
b3N0X2ludGVyZmFjZSA9ICZpbnRmLT5hbHRzZXR0aW5nWzBdOworCWludCBzZWxlY3RfYWx0Owog
CiAJZW0yOHh4X3NldF9tb2RlbChkZXYpOwogCkBAIC0xNjQ3LDYgKzE2NTEsMTggQEAKIAkJfQog
CX0KIAorCS8qIHRoaXMgaXMgZm9yIHByb3RlY3Rpbmcgd3JvbmcgZGV2aWNlcyBhZ2FpbnN0IHRo
ZSByZXN0IG9mIHRoZSBjb250cm9sCisJICAgY29tbWFuZHMKKwkgICBmb3IgZXhhbXBsZToKKwkg
ICAkIGNkIC9zeXMvYnVzL3VzYi9kcml2ZXJzL2VtMjh4eAorCSAgICQgZWNobyAiMTIzNCAxMjM0
IiA+IG5ld19pZAorCSovCisKKworCWlmIChkZXYtPm1vZGVsID09IEVNMjgwMF9CT0FSRF9VTktO
T1dOICYmCisJCWRldi0+Y2hpcF9pZCA+PSBDSElQX0lEX0VNMjg4MykKKwkJZGV2LT5sb2NrX2Nv
bnRyb2xfY29tbWFuZHMgPSAxOworCiAJLyogUHJlcG9wdWxhdGUgY2FjaGVkIEdQTyByZWdpc3Rl
ciBjb250ZW50ICovCiAJcmMgPSBlbTI4eHhfcmVhZF9yZWcoZGV2LCBkZXYtPnJlZ19ncG9fbnVt
KTsKIAlpZiAocmMgPj0gMCkKQEAgLTE2NTgsOCArMTY3NCw2NiBAQAogCWVtMjh4eF93cml0ZV9y
ZWcoZGV2LCBFTTI4WFhfUjA2X0kyQ19DTEssIGRldi0+Ym9hcmQuaTJjX3NwZWVkKTsKIAltc2xl
ZXAoNTApOwogCisJaWYgKGRldi0+bW9kZWwgIT0gRU0yODAwX0JPQVJEX1VOS05PV04pCisJCS8q
IGRlZmF1bHRpbmcgdG8gaGF2ZSB0aGUgc2FtZSBiZWhhdmlvdXIgYXMgd2UgYWx3YXlzIGhhZCAq
LworCQlkZXYtPmhhc19hdHYgPSAxOworCiAJLyogcmVxdWVzdCBzb21lIG1vZHVsZXMgKi8KIAlz
d2l0Y2ggKGRldi0+bW9kZWwpIHsKKwljYXNlIEVNMjgwMF9CT0FSRF9VTktOT1dOOgorCQlpZiAo
ZGV2LT5jaGlwX2lkIDwgQ0hJUF9JRF9FTTI4MjApIHsKKwkJCS8qIGRlZmF1bHRpbmcgYWdhaW4g
Li4gKi8KKwkJCWRldi0+aGFzX2F0diA9IDE7CisJCQlicmVhazsKKwkJfQorCisJCWVtMjh4eF9p
bmZvKCJQcm9iaW5nIGRldmljZSBtb2RlcyAoaWdub3JlIGFsbCB1cGNvbWluZyIKKwkJCSAgICAg
ImVycm9ycylcbiIpOworCQllbTI4eHhfaW5mbygiRm91bmQgZW5kcG9pbnRzOiAlZFxuIiwKKwkJ
CQlob3N0X2ludGVyZmFjZS0+ZGVzYy5iTnVtRW5kcG9pbnRzKTsKKwkJZW0yOHh4X2luZm8oIkZv
dW5kIGFsdGVybmF0ZTogJWRcbiIsIGRldi0+bnVtX2FsdCk7CisKKwkJc3dpdGNoIChkZXYtPm51
bV9hbHQpIHsKKwkJY2FzZSAyOgorCQkJc2VsZWN0X2FsdCA9IDE7CisJCQlicmVhazsKKwkJY2Fz
ZSA4OgorCQkJc2VsZWN0X2FsdCA9IDc7CisJCQlicmVhazsKKwkJZGVmYXVsdDoKKwkJCS8qIGd1
YXJhbnRlZWQgbm8gRUVUSSBUViBkZXZpY2UgKi8KKwkJCXJldHVybiAtRUlOVkFMOworCQl9CisJ
CWZvciAoaSA9IDA7IGkgPCBob3N0X2ludGVyZmFjZS0+ZGVzYy5iTnVtRW5kcG9pbnRzOyBpKysp
IHsKKwkJCWVtMjh4eF9pbmZvKCJBbHRlcm5hdGUgc2V0dGluZyAlZCBbJTAyeF1cbiIsCisJCQkJ
c2VsZWN0X2FsdCwKKwkJCQlpbnRmLT5hbHRzZXR0aW5nW3NlbGVjdF9hbHRdLmVuZHBvaW50W2ld
LgorCQkJCQlkZXNjLmJFbmRwb2ludEFkZHJlc3MpOworCisJCQlzd2l0Y2ggKGludGYtPmFsdHNl
dHRpbmdbc2VsZWN0X2FsdF0uZW5kcG9pbnRbaV0uCisJCQkJZGVzYy5iRW5kcG9pbnRBZGRyZXNz
KSB7CisJCQljYXNlIEVNMjhYWF9JTlRFUlJVUFRfRVA6CisJCQkJLyogY3VycmVudGx5IG5vdCBp
bXBsZW1lbnRlZCAqLworCQkJCWJyZWFrOworCQkJY2FzZSBFTTI4WFhfQU5BTE9HX1ZJREVPX0VQ
OgorCQkJCS8qIHJlZ2lzdGVyZWQgYnkgZGVmYXVsdCBhbHJlYWR5IHdoaWNoCisJCQkJICAgaXMg
Ym9ndXMgKi8KKwkJCQllbTI4eHhfaW5mbygiRk9VTkQgQVRWIEVQXG4iKTsKKwkJCQlkZXYtPmhh
c19hdHYgPSAxOworCQkJCWJyZWFrOworCQkJY2FzZSBFTTI4WFhfQU5BTE9HX0FVRElPX0VQOgor
CQkJCWVtMjh4eF9pbmZvKCJGb3VuZCBQQ01BVURJTyBFUFxuIik7CisJCQkJZGV2LT5oYXNfYWxz
YV9hdWRpbyA9IDE7CisJCQkJYnJlYWs7CisJCQljYXNlIEVNMjhYWF9ESUdJVEFMVFZfRVA6CisJ
CQkJZW0yOHh4X2luZm8oIkZvdW5kIE1QRUctVFMgRVBcbiIpOworCQkJCWRldi0+aGFzX2R2YiA9
IDE7CisJCQkJYnJlYWs7CisJCQlkZWZhdWx0OgorCQkJCXJldHVybiAtRUlOVkFMOworCQkJfQor
CQl9CisJCWJyZWFrOwogCWNhc2UgRU0yODYxX0JPQVJEX1BMRVhUT1JfUFhfVFYxMDBVOgogCQkv
KiBGSVhNRSBndWVzcyAqLwogCQkvKiBUdXJuIG9uIGFuYWxvZyBhdWRpbyBvdXRwdXQgKi8KQEAg
LTE3NDgsNiArMTgyMiw3IEBACiAKIAkvKiBVbmxvY2sgZGV2aWNlICovCiAJZW0yOHh4X3NldF9t
b2RlKGRldiwgRU0yOFhYX1NVU1BFTkQpOworCXJldHVybiAwOwogfQogCiBzdGF0aWMgdm9pZCBl
bTI4eHhfc2V0dXBfeGMzMDI4KHN0cnVjdCBlbTI4eHggKmRldiwgc3RydWN0IHhjMjAyOF9jdHJs
ICpjdGwpCkBAIC0yMTkxLDggKzIyNjYsMTIgQEAKIAlkZXYtPmVtMjh4eF93cml0ZV9yZWdzX3Jl
cSA9IGVtMjh4eF93cml0ZV9yZWdzX3JlcTsKIAlkZXYtPmVtMjh4eF9yZWFkX3JlZ19yZXEgPSBl
bTI4eHhfcmVhZF9yZWdfcmVxOwogCWRldi0+Ym9hcmQuaXNfZW0yODAwID0gZW0yOHh4X2JvYXJk
c1tkZXYtPm1vZGVsXS5pc19lbTI4MDA7CisJZGV2LT5oYXNfZHZiID0gZGV2LT5ib2FyZC5oYXNf
ZHZiOwogCi0JZW0yOHh4X3ByZV9jYXJkX3NldHVwKGRldik7CisJcmV0dmFsID0gZW0yOHh4X3By
ZV9jYXJkX3NldHVwKGRldiwgaW50ZXJmYWNlKTsKKworCWlmIChyZXR2YWwpCisJCXJldHVybiBy
ZXR2YWw7CiAKIAlpZiAoIWRldi0+Ym9hcmQuaXNfZW0yODAwKSB7CiAJCS8qIFNldHMgSTJDIHNw
ZWVkIHRvIDEwMCBLSHogKi8KQEAgLTIyNjUsMTYgKzIzNDQsMTkgQEAKIAogCWVtMjh4eF9hZGRf
aW50b19kZXZsaXN0KGRldik7CiAKLQlyZXR2YWwgPSBlbTI4eHhfcmVnaXN0ZXJfYW5hbG9nX2Rl
dmljZXMoZGV2KTsKLQlpZiAocmV0dmFsIDwgMCkgewotCQllbTI4eHhfcmVsZWFzZV9yZXNvdXJj
ZXMoZGV2KTsKLQkJZ290byBmYWlsX3JlZ19kZXZpY2VzOworCWlmIChkZXYtPmhhc19hdHYpIHsK
KwkJcmV0dmFsID0gZW0yOHh4X3JlZ2lzdGVyX2FuYWxvZ19kZXZpY2VzKGRldik7CisJCWlmIChy
ZXR2YWwgPCAwKSB7CisJCQllbTI4eHhfcmVsZWFzZV9yZXNvdXJjZXMoZGV2KTsKKwkJCWdvdG8g
ZmFpbF9yZWdfZGV2aWNlczsKKwkJfQogCX0KIAogCWVtMjh4eF9pbml0X2V4dGVuc2lvbihkZXYp
OwogCi0JLyogU2F2ZSBzb21lIHBvd2VyIGJ5IHB1dHRpbmcgdHVuZXIgdG8gc2xlZXAgKi8KLQl2
NGwyX2RldmljZV9jYWxsX2FsbCgmZGV2LT52NGwyX2RldiwgMCwgdHVuZXIsIHNfc3RhbmRieSk7
CisJaWYgKGRldi0+aGFzX2F0dikKKwkJLyogU2F2ZSBzb21lIHBvd2VyIGJ5IHB1dHRpbmcgdHVu
ZXIgdG8gc2xlZXAgKi8KKwkJdjRsMl9kZXZpY2VfY2FsbF9hbGwoJmRldi0+djRsMl9kZXYsIDAs
IHR1bmVyLCBzX3N0YW5kYnkpOwogCiAJcmV0dXJuIDA7CiAKZGlmZiAtciAzMTViYzRiNjViNGYg
bGludXgvZHJpdmVycy9tZWRpYS92aWRlby9lbTI4eHgvZW0yOHh4LWNvcmUuYwotLS0gYS9saW51
eC9kcml2ZXJzL21lZGlhL3ZpZGVvL2VtMjh4eC9lbTI4eHgtY29yZS5jCVN1biBNYXkgMTcgMTI6
Mjg6NTUgMjAwOSArMDAwMAorKysgYi9saW51eC9kcml2ZXJzL21lZGlhL3ZpZGVvL2VtMjh4eC9l
bTI4eHgtY29yZS5jCVNhdCBNYXkgMjMgMTY6MDM6MzkgMjAwOSArMDIwMApAQCAtNjgsNyArNjgs
MTIgQEAKIAkJCQkgICBjaGFyICpidWYsIGludCBsZW4pCiB7CiAJaW50IHJldDsKLQlpbnQgcGlw
ZSA9IHVzYl9yY3ZjdHJscGlwZShkZXYtPnVkZXYsIDApOworCWludCBwaXBlOworCisJaWYgKGRl
di0+bG9ja19jb250cm9sX2NvbW1hbmRzKQorCQlyZXR1cm4gLUVJTlZBTDsKKworCXBpcGUgPSB1
c2JfcmN2Y3RybHBpcGUoZGV2LT51ZGV2LCAwKTsKIAogCWlmIChkZXYtPnN0YXRlICYgREVWX0RJ
U0NPTk5FQ1RFRCkKIAkJcmV0dXJuIC1FTk9ERVY7CkBAIC0xNDMsNyArMTQ4LDEyIEBACiAJCQkJ
IGludCBsZW4pCiB7CiAJaW50IHJldDsKLQlpbnQgcGlwZSA9IHVzYl9zbmRjdHJscGlwZShkZXYt
PnVkZXYsIDApOworCWludCBwaXBlOworCisJaWYgKGRldi0+bG9ja19jb250cm9sX2NvbW1hbmRz
KQorCQlyZXR1cm4gLUVJTlZBTDsKKworCXBpcGUgPSB1c2Jfc25kY3RybHBpcGUoZGV2LT51ZGV2
LCAwKTsKIAogCWlmIChkZXYtPnN0YXRlICYgREVWX0RJU0NPTk5FQ1RFRCkKIAkJcmV0dXJuIC1F
Tk9ERVY7CmRpZmYgLXIgMzE1YmM0YjY1YjRmIGxpbnV4L2RyaXZlcnMvbWVkaWEvdmlkZW8vZW0y
OHh4L2VtMjh4eC1kdmIuYwotLS0gYS9saW51eC9kcml2ZXJzL21lZGlhL3ZpZGVvL2VtMjh4eC9l
bTI4eHgtZHZiLmMJU3VuIE1heSAxNyAxMjoyODo1NSAyMDA5ICswMDAwCisrKyBiL2xpbnV4L2Ry
aXZlcnMvbWVkaWEvdmlkZW8vZW0yOHh4L2VtMjh4eC1kdmIuYwlTYXQgTWF5IDIzIDE2OjAzOjM5
IDIwMDkgKzAyMDAKQEAgLTMwMSwxNyArMzAxLDIwIEBACiAJCWdvdG8gZmFpbF9hZGFwdGVyOwog
CX0KIAotCS8qIEVuc3VyZSBhbGwgZnJvbnRlbmRzIG5lZ290aWF0ZSBidXMgYWNjZXNzICovCi0J
ZHZiLT5mcm9udGVuZC0+b3BzLnRzX2J1c19jdHJsID0gZW0yOHh4X2R2Yl9idXNfY3RybDsKKwlp
ZiAoZGV2LT5oYXNfZnJvbnRlbmQpCisJCS8qIEVuc3VyZSBhbGwgZnJvbnRlbmRzIG5lZ290aWF0
ZSBidXMgYWNjZXNzICovCisJCWR2Yi0+ZnJvbnRlbmQtPm9wcy50c19idXNfY3RybCA9IGVtMjh4
eF9kdmJfYnVzX2N0cmw7CiAKIAlkdmItPmFkYXB0ZXIucHJpdiA9IGRldjsKIAotCS8qIHJlZ2lz
dGVyIGZyb250ZW5kICovCi0JcmVzdWx0ID0gZHZiX3JlZ2lzdGVyX2Zyb250ZW5kKCZkdmItPmFk
YXB0ZXIsIGR2Yi0+ZnJvbnRlbmQpOwotCWlmIChyZXN1bHQgPCAwKSB7Ci0JCXByaW50ayhLRVJO
X1dBUk5JTkcgIiVzOiBkdmJfcmVnaXN0ZXJfZnJvbnRlbmQgZmFpbGVkIChlcnJubyA9ICVkKVxu
IiwKLQkJICAgICAgIGRldi0+bmFtZSwgcmVzdWx0KTsKLQkJZ290byBmYWlsX2Zyb250ZW5kOwor
CWlmIChkZXYtPmhhc19mcm9udGVuZCkgeworCQkvKiByZWdpc3RlciBmcm9udGVuZCAqLworCQly
ZXN1bHQgPSBkdmJfcmVnaXN0ZXJfZnJvbnRlbmQoJmR2Yi0+YWRhcHRlciwgZHZiLT5mcm9udGVu
ZCk7CisJCWlmIChyZXN1bHQgPCAwKSB7CisJCQlwcmludGsoS0VSTl9XQVJOSU5HICIlczogZHZi
X3JlZ2lzdGVyX2Zyb250ZW5kIGZhaWxlZCAoZXJybm8gPSAlZClcbiIsCisJCQkJCWRldi0+bmFt
ZSwgcmVzdWx0KTsKKwkJCWdvdG8gZmFpbF9mcm9udGVuZDsKKwkJfQogCX0KIAogCS8qIHJlZ2lz
dGVyIGRlbXV4IHN0dWZmICovCkBAIC0zNDksMTkgKzM1MiwyMyBAQAogCQlnb3RvIGZhaWxfZmVf
aHc7CiAJfQogCi0JZHZiLT5mZV9tZW0uc291cmNlID0gRE1YX01FTU9SWV9GRTsKLQlyZXN1bHQg
PSBkdmItPmRlbXV4LmRteC5hZGRfZnJvbnRlbmQoJmR2Yi0+ZGVtdXguZG14LCAmZHZiLT5mZV9t
ZW0pOwotCWlmIChyZXN1bHQgPCAwKSB7Ci0JCXByaW50ayhLRVJOX1dBUk5JTkcgIiVzOiBhZGRf
ZnJvbnRlbmQgZmFpbGVkIChETVhfTUVNT1JZX0ZFLCBlcnJubyA9ICVkKVxuIiwKLQkJICAgICAg
IGRldi0+bmFtZSwgcmVzdWx0KTsKLQkJZ290byBmYWlsX2ZlX21lbTsKLQl9CisJaWYgKGRldi0+
aGFzX2Zyb250ZW5kKSB7CisJCWR2Yi0+ZmVfbWVtLnNvdXJjZSA9IERNWF9NRU1PUllfRkU7CisJ
CXJlc3VsdCA9IGR2Yi0+ZGVtdXguZG14LmFkZF9mcm9udGVuZCgmZHZiLT5kZW11eC5kbXgsCisJ
CQkJCQkJJmR2Yi0+ZmVfbWVtKTsKKwkJaWYgKHJlc3VsdCA8IDApIHsKKwkJCXByaW50ayhLRVJO
X1dBUk5JTkcgIiVzOiBhZGRfZnJvbnRlbmQgZmFpbGVkIChETVhfTUVNT1JZX0ZFLCBlcnJubyA9
ICVkKVxuIiwKKwkJCQkJZGV2LT5uYW1lLCByZXN1bHQpOworCQkJZ290byBmYWlsX2ZlX21lbTsK
KwkJfQogCi0JcmVzdWx0ID0gZHZiLT5kZW11eC5kbXguY29ubmVjdF9mcm9udGVuZCgmZHZiLT5k
ZW11eC5kbXgsICZkdmItPmZlX2h3KTsKLQlpZiAocmVzdWx0IDwgMCkgewotCQlwcmludGsoS0VS
Tl9XQVJOSU5HICIlczogY29ubmVjdF9mcm9udGVuZCBmYWlsZWQgKGVycm5vID0gJWQpXG4iLAot
CQkgICAgICAgZGV2LT5uYW1lLCByZXN1bHQpOwotCQlnb3RvIGZhaWxfZmVfY29ubjsKKwkJcmVz
dWx0ID0gZHZiLT5kZW11eC5kbXguY29ubmVjdF9mcm9udGVuZCgmZHZiLT5kZW11eC5kbXgsCisJ
CQkJCQkJCSZkdmItPmZlX2h3KTsKKwkJaWYgKHJlc3VsdCA8IDApIHsKKwkJCXByaW50ayhLRVJO
X1dBUk5JTkcgIiVzOiBjb25uZWN0X2Zyb250ZW5kIGZhaWxlZCAoZXJybm8gPSAlZClcbiIsCisJ
CQkJCWRldi0+bmFtZSwgcmVzdWx0KTsKKwkJCWdvdG8gZmFpbF9mZV9jb25uOworCQl9CiAJfQog
CiAJLyogcmVnaXN0ZXIgbmV0d29yayBhZGFwdGVyICovCkBAIC0zNzcsOSArMzg0LDEyIEBACiBm
YWlsX2RteGRldjoKIAlkdmJfZG14X3JlbGVhc2UoJmR2Yi0+ZGVtdXgpOwogZmFpbF9kbXg6Ci0J
ZHZiX3VucmVnaXN0ZXJfZnJvbnRlbmQoZHZiLT5mcm9udGVuZCk7CisJaWYgKGRldi0+aGFzX2Zy
b250ZW5kKQorCQlkdmJfdW5yZWdpc3Rlcl9mcm9udGVuZChkdmItPmZyb250ZW5kKTsKIGZhaWxf
ZnJvbnRlbmQ6Ci0JZHZiX2Zyb250ZW5kX2RldGFjaChkdmItPmZyb250ZW5kKTsKKwlpZiAoZGV2
LT5oYXNfZnJvbnRlbmQpCisJCWR2Yl9mcm9udGVuZF9kZXRhY2goZHZiLT5mcm9udGVuZCk7CisK
IAlkdmJfdW5yZWdpc3Rlcl9hZGFwdGVyKCZkdmItPmFkYXB0ZXIpOwogZmFpbF9hZGFwdGVyOgog
CXJldHVybiByZXN1bHQ7CkBAIC0zODgsMTIgKzM5OCwxNyBAQAogc3RhdGljIHZvaWQgdW5yZWdp
c3Rlcl9kdmIoc3RydWN0IGVtMjh4eF9kdmIgKmR2YikKIHsKIAlkdmJfbmV0X3JlbGVhc2UoJmR2
Yi0+bmV0KTsKLQlkdmItPmRlbXV4LmRteC5yZW1vdmVfZnJvbnRlbmQoJmR2Yi0+ZGVtdXguZG14
LCAmZHZiLT5mZV9tZW0pOwotCWR2Yi0+ZGVtdXguZG14LnJlbW92ZV9mcm9udGVuZCgmZHZiLT5k
ZW11eC5kbXgsICZkdmItPmZlX2h3KTsKKwlpZiAoZHZiLT5mcm9udGVuZCkgeworCQlkdmItPmRl
bXV4LmRteC5yZW1vdmVfZnJvbnRlbmQoJmR2Yi0+ZGVtdXguZG14LCAmZHZiLT5mZV9tZW0pOwor
CQlkdmItPmRlbXV4LmRteC5yZW1vdmVfZnJvbnRlbmQoJmR2Yi0+ZGVtdXguZG14LCAmZHZiLT5m
ZV9odyk7CisJfQogCWR2Yl9kbXhkZXZfcmVsZWFzZSgmZHZiLT5kbXhkZXYpOwogCWR2Yl9kbXhf
cmVsZWFzZSgmZHZiLT5kZW11eCk7Ci0JZHZiX3VucmVnaXN0ZXJfZnJvbnRlbmQoZHZiLT5mcm9u
dGVuZCk7Ci0JZHZiX2Zyb250ZW5kX2RldGFjaChkdmItPmZyb250ZW5kKTsKKwlpZiAoZHZiLT5m
cm9udGVuZCkgeworCQlkdmJfdW5yZWdpc3Rlcl9mcm9udGVuZChkdmItPmZyb250ZW5kKTsKKwkJ
ZHZiX2Zyb250ZW5kX2RldGFjaChkdmItPmZyb250ZW5kKTsKKwkJZHZiLT5mcm9udGVuZCA9IE5V
TEw7CisJfQogCWR2Yl91bnJlZ2lzdGVyX2FkYXB0ZXIoJmR2Yi0+YWRhcHRlcik7CiB9CiAKQEAg
LTQwMyw4ICs0MTgsOSBAQAogCWludCByZXN1bHQgPSAwOwogCXN0cnVjdCBlbTI4eHhfZHZiICpk
dmI7CiAKLQlpZiAoIWRldi0+Ym9hcmQuaGFzX2R2YikgeworCWlmICghZGV2LT5ib2FyZC5oYXNf
ZHZiICYmIGRldi0+aGFzX2R2YiA9PSAwKSB7CiAJCS8qIFRoaXMgZGV2aWNlIGRvZXMgbm90IHN1
cHBvcnQgdGhlIGV4dGVuc2lvbiAqLworCQlwcmludGsoS0VSTl9JTkZPICJlbTI4eHhfZHZiOiBU
aGlzIGRldmljZSBkb2VzIG5vdCBzdXBwb3J0IHRoZSBEVkIgZXh0ZW5zaW9uXG4iKTsKIAkJcmV0
dXJuIDA7CiAJfQogCkBAIC00MTUsNiArNDMxLDcgQEAKIAkJcmV0dXJuIC1FTk9NRU07CiAJfQog
CWRldi0+ZHZiID0gZHZiOworCWRldi0+aGFzX2Zyb250ZW5kID0gMTsgLyogZGVmYXVsdGluZyBm
b3Igb2xkIGRldmljZXMgKi8KIAogCWVtMjh4eF9zZXRfbW9kZShkZXYsIEVNMjhYWF9ESUdJVEFM
X01PREUpOwogCS8qIGluaXQgZnJvbnRlbmQgKi8KQEAgLTQ2NSwyMSArNDgyLDI2IEBACiAJCX0K
IAkJYnJlYWs7CiAjZW5kaWYKKwljYXNlIEVNMjgwMF9CT0FSRF9VTktOT1dOOgorCQlkZXYtPmhh
c19mcm9udGVuZCA9IDA7CisJCWJyZWFrOwogCWRlZmF1bHQ6CiAJCXByaW50ayhLRVJOX0VSUiAi
JXMvMjogVGhlIGZyb250ZW5kIG9mIHlvdXIgRFZCL0FUU0MgY2FyZCIKIAkJCQkiIGlzbid0IHN1
cHBvcnRlZCB5ZXRcbiIsCiAJCSAgICAgICBkZXYtPm5hbWUpOwogCQlicmVhazsKIAl9Ci0JaWYg
KE5VTEwgPT0gZHZiLT5mcm9udGVuZCkgeworCWlmIChOVUxMID09IGR2Yi0+ZnJvbnRlbmQgJiYg
ZGV2LT5oYXNfZnJvbnRlbmQgPT0gMSkgewogCQlwcmludGsoS0VSTl9FUlIKIAkJICAgICAgICIl
cy8yOiBmcm9udGVuZCBpbml0aWFsaXphdGlvbiBmYWlsZWRcbiIsCiAJCSAgICAgICBkZXYtPm5h
bWUpOwogCQlyZXN1bHQgPSAtRUlOVkFMOwogCQlnb3RvIG91dF9mcmVlOwogCX0KLQkvKiBkZWZp
bmUgZ2VuZXJhbC1wdXJwb3NlIGNhbGxiYWNrIHBvaW50ZXIgKi8KLQlkdmItPmZyb250ZW5kLT5j
YWxsYmFjayA9IGVtMjh4eF90dW5lcl9jYWxsYmFjazsKKworCWlmIChkZXYtPmhhc19mcm9udGVu
ZCkKKwkJLyogZGVmaW5lIGdlbmVyYWwtcHVycG9zZSBjYWxsYmFjayBwb2ludGVyICovCisJCWR2
Yi0+ZnJvbnRlbmQtPmNhbGxiYWNrID0gZW0yOHh4X3R1bmVyX2NhbGxiYWNrOwogCiAJLyogcmVn
aXN0ZXIgZXZlcnl0aGluZyAqLwogCXJlc3VsdCA9IHJlZ2lzdGVyX2R2YihkdmIsIFRISVNfTU9E
VUxFLCBkZXYsICZkZXYtPnVkZXYtPmRldik7CmRpZmYgLXIgMzE1YmM0YjY1YjRmIGxpbnV4L2Ry
aXZlcnMvbWVkaWEvdmlkZW8vZW0yOHh4L2VtMjh4eC5oCi0tLSBhL2xpbnV4L2RyaXZlcnMvbWVk
aWEvdmlkZW8vZW0yOHh4L2VtMjh4eC5oCVN1biBNYXkgMTcgMTI6Mjg6NTUgMjAwOSArMDAwMAor
KysgYi9saW51eC9kcml2ZXJzL21lZGlhL3ZpZGVvL2VtMjh4eC9lbTI4eHguaAlTYXQgTWF5IDIz
IDE2OjAzOjM5IDIwMDkgKzAyMDAKQEAgLTQyOSw2ICs0MjksMTEgQEAKICNkZWZpbmUgRU0yOFhY
X0FVRElPICAgMHgxMAogI2RlZmluZSBFTTI4WFhfRFZCICAgICAweDIwCiAKKyNkZWZpbmUgRU0y
OFhYX0lOVEVSUlVQVF9FUAkweDgxCisjZGVmaW5lIEVNMjhYWF9BTkFMT0dfVklERU9fRVAJMHg4
MgorI2RlZmluZSBFTTI4WFhfQU5BTE9HX0FVRElPX0VQCTB4ODMKKyNkZWZpbmUgRU0yOFhYX0RJ
R0lUQUxUVl9FUAkweDg0CisKIHN0cnVjdCBlbTI4eHhfYXVkaW8gewogCWNoYXIgbmFtZVs1MF07
CiAJY2hhciAqdHJhbnNmZXJfYnVmZmVyW0VNMjhYWF9BVURJT19CVUZTXTsKQEAgLTQ3OSw2ICs0
ODQsMTMgQEAKIAl1bnNpZ25lZCBpbnQgc3RyZWFtX29uOjE7CS8qIExvY2tzIHN0cmVhbXMgKi8K
IAl1bnNpZ25lZCBpbnQgaGFzX2F1ZGlvX2NsYXNzOjE7CiAJdW5zaWduZWQgaW50IGhhc19hbHNh
X2F1ZGlvOjE7CisJLyogc29tZSBkZXZpY2VzIGRvIG5vdCBoYXZlIGEgZnJvbnRlbmQsCisJICAg
ZWcgcmVhZGluZyBUUyBzdHJlYW0gb25seSBmcm9tIGFsdGVybmF0aXZlCisJICAgc291cmNlcyBl
Zy4gbXBlZyBlbmNvZGVyIGRldmljZXMgKi8KKwl1bnNpZ25lZCBpbnQgaGFzX2Zyb250ZW5kOjE7
CisJLyogcHJpdmF0ZSBzZWN0aW9uLCBvbmx5IGlmIF90aGlzXyBib2FyZCBzdXBwb3J0cyBtcGVn
LXRzICovCisJdW5zaWduZWQgaW50IGhhc19kdmI6MTsKKwl1bnNpZ25lZCBpbnQgaGFzX2F0djox
OwogCiAJc3RydWN0IGVtMjh4eF9mbXQgKmZvcm1hdDsKIApAQCAtNTgwLDYgKzU5Miw4IEBACiAJ
c3RydWN0IGRlbGF5ZWRfd29yayBzYnV0dG9uX3F1ZXJ5X3dvcms7CiAKIAlzdHJ1Y3QgZW0yOHh4
X2R2YiAqZHZiOworCisJdW5zaWduZWQgaW50IGxvY2tfY29udHJvbF9jb21tYW5kczoxOwogfTsK
IAogc3RydWN0IGVtMjh4eF9vcHMgewpAQCAtNjQ1LDcgKzY1OSw2IEBACiAKIC8qIFByb3ZpZGVk
IGJ5IGVtMjh4eC1jYXJkcy5jICovCiBleHRlcm4gaW50IGVtMjgwMF92YXJpYW50X2RldGVjdChz
dHJ1Y3QgdXNiX2RldmljZSAqdWRldiwgaW50IG1vZGVsKTsKLWV4dGVybiB2b2lkIGVtMjh4eF9w
cmVfY2FyZF9zZXR1cChzdHJ1Y3QgZW0yOHh4ICpkZXYpOwogZXh0ZXJuIHZvaWQgZW0yOHh4X2Nh
cmRfc2V0dXAoc3RydWN0IGVtMjh4eCAqZGV2KTsKIGV4dGVybiBzdHJ1Y3QgZW0yOHh4X2JvYXJk
IGVtMjh4eF9ib2FyZHNbXTsKIGV4dGVybiBzdHJ1Y3QgdXNiX2RldmljZV9pZCBlbTI4eHhfaWRf
dGFibGVbXTsK
--0016e6587a0c9d470f046a94dc6a--
