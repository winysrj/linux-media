Return-path: <linux-media-owner@vger.kernel.org>
Received: from ns1.tyldum.com ([91.189.178.231]:43881 "EHLO ns1.tyldum.com"
	rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
	id S1754712Ab1LMSL1 (ORCPT <rfc822;linux-media@vger.kernel.org>);
	Tue, 13 Dec 2011 13:11:27 -0500
Message-ID: <4EE79543.2080802@tyldum.com>
Date: Tue, 13 Dec 2011 19:11:15 +0100
From: Vidar Tyldum <vidar@tyldum.com>
MIME-Version: 1.0
To: Marko Ristola <marko.ristola@kolumbus.fi>
CC: Linux Media Mailing List <linux-media@vger.kernel.org>
Subject: Re: Multiple Mantis devices gives me glitches
References: <4EE6FF6F.5050901@kolumbus.fi>
In-Reply-To: <4EE6FF6F.5050901@kolumbus.fi>
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit
Sender: linux-media-owner@vger.kernel.org
List-ID: <linux-media.vger.kernel.org>

13.12.2011 08:31, Marko Ristola:
> 
> Hi
> 
> Here is a patch that went into Linus GIT this year.
> It reduces the number of DMA transfer interrupts into one third.
> Linus released 2.6.38.8 doesn't seem to have this patch yet

Good news, combining this patch with IRQ management fixes the problem for me.

Status:
 * Stock 2.6.38.8 mantis, no IRQ management:     glitches
 * Stock 2.6.38.8 mantis, with IRQ management:   glitches
 * Patched 2.6.38.8 mantis, no IRQ management:   glitches (less)
 * Patched 2.6.38.8 mantis, with IRQ management: very few glitches
 * Same as above, but latency_timer set to 0xff: no glitches in one hour

The patch was applied to 2.6.38.8 (in Ubuntu terms: 2.6.38-13-generic-pae).
Tests involved having VDR record on three different transponders at the same
time, which means lots of IO and all three cards active at once.

For IRQ management I tried both 'irqbalancer' and manual setting with IRQ
affinity (which is basicly what irqbalancer does).

I tried playing with the latency timer on the other scenarios, not only the
last one, but all had glitches anyways.

Not sure what to conclude with:
 - Unfortunate IRQ handling on this CPU (two and two share IRQ handling)?
 - Too many interrupts generated by driver (design issues)?
 - Driver not handling SMP gracefully?
...or a combination?

Your patch is definately needed. Is there anything I can do to help getting
it in?


-- 
Vidar Tyldum
                              vidar@tyldum.com               PGP: 0x3110AA98
