Return-path: <linux-media-owner@vger.kernel.org>
Received: from mail-fx0-f168.google.com ([209.85.220.168]:42771 "EHLO
	mail-fx0-f168.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1752682AbZEWPFh (ORCPT
	<rfc822;linux-media@vger.kernel.org>);
	Sat, 23 May 2009 11:05:37 -0400
Received: by fxm12 with SMTP id 12so410801fxm.37
        for <linux-media@vger.kernel.org>; Sat, 23 May 2009 08:05:37 -0700 (PDT)
MIME-Version: 1.0
In-Reply-To: <d9def9db0905230749r3e39de5m3f4e1c28c1d596bd@mail.gmail.com>
References: <d9def9db0905230704n4f8b725aj3dc3021187d5ae12@mail.gmail.com>
	 <d9def9db0905230749r3e39de5m3f4e1c28c1d596bd@mail.gmail.com>
Date: Sat, 23 May 2009 17:05:37 +0200
Message-ID: <d9def9db0905230805h5258a9b6h7920a5bd4ce62e7c@mail.gmail.com>
Subject: Re: [PATCH] em28xx device mode detection based on endpoints
From: Markus Rechberger <mrechberger@gmail.com>
To: linux-media@vger.kernel.org
Content-Type: multipart/mixed; boundary=0016e659fa66a808c8046a95b56c
Sender: linux-media-owner@vger.kernel.org
List-ID: <linux-media.vger.kernel.org>

--0016e659fa66a808c8046a95b56c
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit

Hi,

On Sat, May 23, 2009 at 4:49 PM, Markus Rechberger
<mrechberger@gmail.com> wrote:
> On Sat, May 23, 2009 at 4:04 PM, Markus Rechberger
> <mrechberger@gmail.com> wrote:
>> Hi,
>>
>> for em28xx devices the device node detection can be based on the
>> encoded endpoint address, for example EP 0x81 (USB IN, Interrupt),
>> 0x82 (analog video EP), 0x83 (analog audio ep), 0x84 (mpeg-ts input
>> EP).
>> It is not necessary that digital TV devices have a frontend, the
>> em28xx chip only specifies an MPEG-TS input EP.
>>
>> Following patch adds a check based on the Endpoints, although it might
>> be extended that all devices match the possible devicenodes based on
>> the endpoints, currently the driver registers an analog TV node by
>> default for all unknown devices which is not necessarily correct, this
>> patch disables the ATV node if no analog TV endpoint is available.
>>
>

attached patch fixes the deregistration, as well loads the em28xx-dvb
module automatically as soon as an MPEG-TS endpoint was found.

Signed-off-by: Markus Rechberger <mrechberger@gmail.com>

best regards,
Markus

--0016e659fa66a808c8046a95b56c
Content-Type: text/x-diff; charset=US-ASCII; name="em28xx_ep_nodedetection-2.diff"
Content-Disposition: attachment; filename="em28xx_ep_nodedetection-2.diff"
Content-Transfer-Encoding: base64
X-Attachment-Id: f_fv2ga5750

ZGlmZiAtciAzMTViYzRiNjViNGYgbGludXgvZHJpdmVycy9tZWRpYS92aWRlby9lbTI4eHgvZW0y
OHh4LWNhcmRzLmMKLS0tIGEvbGludXgvZHJpdmVycy9tZWRpYS92aWRlby9lbTI4eHgvZW0yOHh4
LWNhcmRzLmMJU3VuIE1heSAxNyAxMjoyODo1NSAyMDA5ICswMDAwCisrKyBiL2xpbnV4L2RyaXZl
cnMvbWVkaWEvdmlkZW8vZW0yOHh4L2VtMjh4eC1jYXJkcy5jCVNhdCBNYXkgMjMgMTc6MDM6MDAg
MjAwOSArMDIwMApAQCAtMTU5Niw5ICsxNTk2LDEzIEBACiAvKiBTaW5jZSBlbTI4eHhfcHJlX2Nh
cmRfc2V0dXAoKSByZXF1aXJlcyBhIHByb3BlciBkZXYtPm1vZGVsLAogICogdGhpcyB3b24ndCB3
b3JrIGZvciBib2FyZHMgd2l0aCBnZW5lcmljIFBDSSBJRHMKICAqLwotdm9pZCBlbTI4eHhfcHJl
X2NhcmRfc2V0dXAoc3RydWN0IGVtMjh4eCAqZGV2KQorc3RhdGljIGludCBlbTI4eHhfcHJlX2Nh
cmRfc2V0dXAoc3RydWN0IGVtMjh4eCAqZGV2LAorCQkJCXN0cnVjdCB1c2JfaW50ZXJmYWNlICpp
bnRmKQogewogCWludCByYzsKKwlpbnQgaTsKKwlzdHJ1Y3QgdXNiX2hvc3RfaW50ZXJmYWNlICpo
b3N0X2ludGVyZmFjZSA9ICZpbnRmLT5hbHRzZXR0aW5nWzBdOworCWludCBzZWxlY3RfYWx0Owog
CiAJZW0yOHh4X3NldF9tb2RlbChkZXYpOwogCkBAIC0xNjQ3LDYgKzE2NTEsMTggQEAKIAkJfQog
CX0KIAorCS8qIHRoaXMgaXMgZm9yIHByb3RlY3Rpbmcgd3JvbmcgZGV2aWNlcyBhZ2FpbnN0IHRo
ZSByZXN0IG9mIHRoZSBjb250cm9sCisJICAgY29tbWFuZHMKKwkgICBmb3IgZXhhbXBsZToKKwkg
ICAkIGNkIC9zeXMvYnVzL3VzYi9kcml2ZXJzL2VtMjh4eAorCSAgICQgZWNobyAiMTIzNCAxMjM0
IiA+IG5ld19pZAorCSovCisKKworCWlmIChkZXYtPm1vZGVsID09IEVNMjgwMF9CT0FSRF9VTktO
T1dOICYmCisJCWRldi0+Y2hpcF9pZCA+PSBDSElQX0lEX0VNMjg4MykKKwkJZGV2LT5sb2NrX2Nv
bnRyb2xfY29tbWFuZHMgPSAxOworCiAJLyogUHJlcG9wdWxhdGUgY2FjaGVkIEdQTyByZWdpc3Rl
ciBjb250ZW50ICovCiAJcmMgPSBlbTI4eHhfcmVhZF9yZWcoZGV2LCBkZXYtPnJlZ19ncG9fbnVt
KTsKIAlpZiAocmMgPj0gMCkKQEAgLTE2NTgsOCArMTY3NCw2NiBAQAogCWVtMjh4eF93cml0ZV9y
ZWcoZGV2LCBFTTI4WFhfUjA2X0kyQ19DTEssIGRldi0+Ym9hcmQuaTJjX3NwZWVkKTsKIAltc2xl
ZXAoNTApOwogCisJaWYgKGRldi0+bW9kZWwgIT0gRU0yODAwX0JPQVJEX1VOS05PV04pCisJCS8q
IGRlZmF1bHRpbmcgdG8gaGF2ZSB0aGUgc2FtZSBiZWhhdmlvdXIgYXMgd2UgYWx3YXlzIGhhZCAq
LworCQlkZXYtPmhhc19hdHYgPSAxOworCiAJLyogcmVxdWVzdCBzb21lIG1vZHVsZXMgKi8KIAlz
d2l0Y2ggKGRldi0+bW9kZWwpIHsKKwljYXNlIEVNMjgwMF9CT0FSRF9VTktOT1dOOgorCQlpZiAo
ZGV2LT5jaGlwX2lkIDwgQ0hJUF9JRF9FTTI4MjApIHsKKwkJCS8qIGRlZmF1bHRpbmcgYWdhaW4g
Li4gKi8KKwkJCWRldi0+aGFzX2F0diA9IDE7CisJCQlicmVhazsKKwkJfQorCisJCWVtMjh4eF9p
bmZvKCJQcm9iaW5nIGRldmljZSBtb2RlcyAoaWdub3JlIGFsbCB1cGNvbWluZyIKKwkJCSAgICAg
ImVycm9ycylcbiIpOworCQllbTI4eHhfaW5mbygiRm91bmQgZW5kcG9pbnRzOiAlZFxuIiwKKwkJ
CQlob3N0X2ludGVyZmFjZS0+ZGVzYy5iTnVtRW5kcG9pbnRzKTsKKwkJZW0yOHh4X2luZm8oIkZv
dW5kIGFsdGVybmF0ZTogJWRcbiIsIGRldi0+bnVtX2FsdCk7CisKKwkJc3dpdGNoIChkZXYtPm51
bV9hbHQpIHsKKwkJY2FzZSAyOgorCQkJc2VsZWN0X2FsdCA9IDE7CisJCQlicmVhazsKKwkJY2Fz
ZSA4OgorCQkJc2VsZWN0X2FsdCA9IDc7CisJCQlicmVhazsKKwkJZGVmYXVsdDoKKwkJCS8qIGd1
YXJhbnRlZWQgbm8gRUVUSSBUViBkZXZpY2UgKi8KKwkJCXJldHVybiAtRUlOVkFMOworCQl9CisJ
CWZvciAoaSA9IDA7IGkgPCBob3N0X2ludGVyZmFjZS0+ZGVzYy5iTnVtRW5kcG9pbnRzOyBpKysp
IHsKKwkJCWVtMjh4eF9pbmZvKCJBbHRlcm5hdGUgc2V0dGluZyAlZCBbJTAyeF1cbiIsCisJCQkJ
c2VsZWN0X2FsdCwKKwkJCQlpbnRmLT5hbHRzZXR0aW5nW3NlbGVjdF9hbHRdLmVuZHBvaW50W2ld
LgorCQkJCQlkZXNjLmJFbmRwb2ludEFkZHJlc3MpOworCisJCQlzd2l0Y2ggKGludGYtPmFsdHNl
dHRpbmdbc2VsZWN0X2FsdF0uZW5kcG9pbnRbaV0uCisJCQkJZGVzYy5iRW5kcG9pbnRBZGRyZXNz
KSB7CisJCQljYXNlIEVNMjhYWF9JTlRFUlJVUFRfRVA6CisJCQkJLyogY3VycmVudGx5IG5vdCBp
bXBsZW1lbnRlZCAqLworCQkJCWJyZWFrOworCQkJY2FzZSBFTTI4WFhfQU5BTE9HX1ZJREVPX0VQ
OgorCQkJCS8qIHJlZ2lzdGVyZWQgYnkgZGVmYXVsdCBhbHJlYWR5IHdoaWNoCisJCQkJICAgaXMg
Ym9ndXMgKi8KKwkJCQllbTI4eHhfaW5mbygiRk9VTkQgQVRWIEVQXG4iKTsKKwkJCQlkZXYtPmhh
c19hdHYgPSAxOworCQkJCWJyZWFrOworCQkJY2FzZSBFTTI4WFhfQU5BTE9HX0FVRElPX0VQOgor
CQkJCWVtMjh4eF9pbmZvKCJGb3VuZCBQQ01BVURJTyBFUFxuIik7CisJCQkJZGV2LT5oYXNfYWxz
YV9hdWRpbyA9IDE7CisJCQkJYnJlYWs7CisJCQljYXNlIEVNMjhYWF9ESUdJVEFMVFZfRVA6CisJ
CQkJZW0yOHh4X2luZm8oIkZvdW5kIE1QRUctVFMgRVBcbiIpOworCQkJCWRldi0+aGFzX2R2YiA9
IDE7CisJCQkJYnJlYWs7CisJCQlkZWZhdWx0OgorCQkJCXJldHVybiAtRUlOVkFMOworCQkJfQor
CQl9CisJCWJyZWFrOwogCWNhc2UgRU0yODYxX0JPQVJEX1BMRVhUT1JfUFhfVFYxMDBVOgogCQkv
KiBGSVhNRSBndWVzcyAqLwogCQkvKiBUdXJuIG9uIGFuYWxvZyBhdWRpbyBvdXRwdXQgKi8KQEAg
LTE3NDgsNiArMTgyMiw3IEBACiAKIAkvKiBVbmxvY2sgZGV2aWNlICovCiAJZW0yOHh4X3NldF9t
b2RlKGRldiwgRU0yOFhYX1NVU1BFTkQpOworCXJldHVybiAwOwogfQogCiBzdGF0aWMgdm9pZCBl
bTI4eHhfc2V0dXBfeGMzMDI4KHN0cnVjdCBlbTI4eHggKmRldiwgc3RydWN0IHhjMjAyOF9jdHJs
ICpjdGwpCkBAIC0yMTE5LDcgKzIxOTQsNyBAQAogCWVsc2UgaWYgKGRldi0+aGFzX2Fsc2FfYXVk
aW8pCiAJCXJlcXVlc3RfbW9kdWxlKCJlbTI4eHgtYWxzYSIpOwogCi0JaWYgKGRldi0+Ym9hcmQu
aGFzX2R2YikKKwlpZiAoZGV2LT5ib2FyZC5oYXNfZHZiIHx8IGRldi0+aGFzX2R2YikKIAkJcmVx
dWVzdF9tb2R1bGUoImVtMjh4eC1kdmIiKTsKIH0KIApAQCAtMjE5MSw4ICsyMjY2LDEyIEBACiAJ
ZGV2LT5lbTI4eHhfd3JpdGVfcmVnc19yZXEgPSBlbTI4eHhfd3JpdGVfcmVnc19yZXE7CiAJZGV2
LT5lbTI4eHhfcmVhZF9yZWdfcmVxID0gZW0yOHh4X3JlYWRfcmVnX3JlcTsKIAlkZXYtPmJvYXJk
LmlzX2VtMjgwMCA9IGVtMjh4eF9ib2FyZHNbZGV2LT5tb2RlbF0uaXNfZW0yODAwOworCWRldi0+
aGFzX2R2YiA9IGRldi0+Ym9hcmQuaGFzX2R2YjsKIAotCWVtMjh4eF9wcmVfY2FyZF9zZXR1cChk
ZXYpOworCXJldHZhbCA9IGVtMjh4eF9wcmVfY2FyZF9zZXR1cChkZXYsIGludGVyZmFjZSk7CisK
KwlpZiAocmV0dmFsKQorCQlyZXR1cm4gcmV0dmFsOwogCiAJaWYgKCFkZXYtPmJvYXJkLmlzX2Vt
MjgwMCkgewogCQkvKiBTZXRzIEkyQyBzcGVlZCB0byAxMDAgS0h6ICovCkBAIC0yMjY1LDE2ICsy
MzQ0LDE5IEBACiAKIAllbTI4eHhfYWRkX2ludG9fZGV2bGlzdChkZXYpOwogCi0JcmV0dmFsID0g
ZW0yOHh4X3JlZ2lzdGVyX2FuYWxvZ19kZXZpY2VzKGRldik7Ci0JaWYgKHJldHZhbCA8IDApIHsK
LQkJZW0yOHh4X3JlbGVhc2VfcmVzb3VyY2VzKGRldik7Ci0JCWdvdG8gZmFpbF9yZWdfZGV2aWNl
czsKKwlpZiAoZGV2LT5oYXNfYXR2KSB7CisJCXJldHZhbCA9IGVtMjh4eF9yZWdpc3Rlcl9hbmFs
b2dfZGV2aWNlcyhkZXYpOworCQlpZiAocmV0dmFsIDwgMCkgeworCQkJZW0yOHh4X3JlbGVhc2Vf
cmVzb3VyY2VzKGRldik7CisJCQlnb3RvIGZhaWxfcmVnX2RldmljZXM7CisJCX0KIAl9CiAKIAll
bTI4eHhfaW5pdF9leHRlbnNpb24oZGV2KTsKIAotCS8qIFNhdmUgc29tZSBwb3dlciBieSBwdXR0
aW5nIHR1bmVyIHRvIHNsZWVwICovCi0JdjRsMl9kZXZpY2VfY2FsbF9hbGwoJmRldi0+djRsMl9k
ZXYsIDAsIHR1bmVyLCBzX3N0YW5kYnkpOworCWlmIChkZXYtPmhhc19hdHYpCisJCS8qIFNhdmUg
c29tZSBwb3dlciBieSBwdXR0aW5nIHR1bmVyIHRvIHNsZWVwICovCisJCXY0bDJfZGV2aWNlX2Nh
bGxfYWxsKCZkZXYtPnY0bDJfZGV2LCAwLCB0dW5lciwgc19zdGFuZGJ5KTsKIAogCXJldHVybiAw
OwogCmRpZmYgLXIgMzE1YmM0YjY1YjRmIGxpbnV4L2RyaXZlcnMvbWVkaWEvdmlkZW8vZW0yOHh4
L2VtMjh4eC1jb3JlLmMKLS0tIGEvbGludXgvZHJpdmVycy9tZWRpYS92aWRlby9lbTI4eHgvZW0y
OHh4LWNvcmUuYwlTdW4gTWF5IDE3IDEyOjI4OjU1IDIwMDkgKzAwMDAKKysrIGIvbGludXgvZHJp
dmVycy9tZWRpYS92aWRlby9lbTI4eHgvZW0yOHh4LWNvcmUuYwlTYXQgTWF5IDIzIDE3OjAzOjAw
IDIwMDkgKzAyMDAKQEAgLTY4LDcgKzY4LDEyIEBACiAJCQkJICAgY2hhciAqYnVmLCBpbnQgbGVu
KQogewogCWludCByZXQ7Ci0JaW50IHBpcGUgPSB1c2JfcmN2Y3RybHBpcGUoZGV2LT51ZGV2LCAw
KTsKKwlpbnQgcGlwZTsKKworCWlmIChkZXYtPmxvY2tfY29udHJvbF9jb21tYW5kcykKKwkJcmV0
dXJuIC1FSU5WQUw7CisKKwlwaXBlID0gdXNiX3JjdmN0cmxwaXBlKGRldi0+dWRldiwgMCk7CiAK
IAlpZiAoZGV2LT5zdGF0ZSAmIERFVl9ESVNDT05ORUNURUQpCiAJCXJldHVybiAtRU5PREVWOwpA
QCAtMTQzLDcgKzE0OCwxMiBAQAogCQkJCSBpbnQgbGVuKQogewogCWludCByZXQ7Ci0JaW50IHBp
cGUgPSB1c2Jfc25kY3RybHBpcGUoZGV2LT51ZGV2LCAwKTsKKwlpbnQgcGlwZTsKKworCWlmIChk
ZXYtPmxvY2tfY29udHJvbF9jb21tYW5kcykKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlwaXBlID0g
dXNiX3NuZGN0cmxwaXBlKGRldi0+dWRldiwgMCk7CiAKIAlpZiAoZGV2LT5zdGF0ZSAmIERFVl9E
SVNDT05ORUNURUQpCiAJCXJldHVybiAtRU5PREVWOwpkaWZmIC1yIDMxNWJjNGI2NWI0ZiBsaW51
eC9kcml2ZXJzL21lZGlhL3ZpZGVvL2VtMjh4eC9lbTI4eHgtZHZiLmMKLS0tIGEvbGludXgvZHJp
dmVycy9tZWRpYS92aWRlby9lbTI4eHgvZW0yOHh4LWR2Yi5jCVN1biBNYXkgMTcgMTI6Mjg6NTUg
MjAwOSArMDAwMAorKysgYi9saW51eC9kcml2ZXJzL21lZGlhL3ZpZGVvL2VtMjh4eC9lbTI4eHgt
ZHZiLmMJU2F0IE1heSAyMyAxNzowMzowMCAyMDA5ICswMjAwCkBAIC0zMDEsMTcgKzMwMSwyMCBA
QAogCQlnb3RvIGZhaWxfYWRhcHRlcjsKIAl9CiAKLQkvKiBFbnN1cmUgYWxsIGZyb250ZW5kcyBu
ZWdvdGlhdGUgYnVzIGFjY2VzcyAqLwotCWR2Yi0+ZnJvbnRlbmQtPm9wcy50c19idXNfY3RybCA9
IGVtMjh4eF9kdmJfYnVzX2N0cmw7CisJaWYgKGRldi0+aGFzX2Zyb250ZW5kKQorCQkvKiBFbnN1
cmUgYWxsIGZyb250ZW5kcyBuZWdvdGlhdGUgYnVzIGFjY2VzcyAqLworCQlkdmItPmZyb250ZW5k
LT5vcHMudHNfYnVzX2N0cmwgPSBlbTI4eHhfZHZiX2J1c19jdHJsOwogCiAJZHZiLT5hZGFwdGVy
LnByaXYgPSBkZXY7CiAKLQkvKiByZWdpc3RlciBmcm9udGVuZCAqLwotCXJlc3VsdCA9IGR2Yl9y
ZWdpc3Rlcl9mcm9udGVuZCgmZHZiLT5hZGFwdGVyLCBkdmItPmZyb250ZW5kKTsKLQlpZiAocmVz
dWx0IDwgMCkgewotCQlwcmludGsoS0VSTl9XQVJOSU5HICIlczogZHZiX3JlZ2lzdGVyX2Zyb250
ZW5kIGZhaWxlZCAoZXJybm8gPSAlZClcbiIsCi0JCSAgICAgICBkZXYtPm5hbWUsIHJlc3VsdCk7
Ci0JCWdvdG8gZmFpbF9mcm9udGVuZDsKKwlpZiAoZGV2LT5oYXNfZnJvbnRlbmQpIHsKKwkJLyog
cmVnaXN0ZXIgZnJvbnRlbmQgKi8KKwkJcmVzdWx0ID0gZHZiX3JlZ2lzdGVyX2Zyb250ZW5kKCZk
dmItPmFkYXB0ZXIsIGR2Yi0+ZnJvbnRlbmQpOworCQlpZiAocmVzdWx0IDwgMCkgeworCQkJcHJp
bnRrKEtFUk5fV0FSTklORyAiJXM6IGR2Yl9yZWdpc3Rlcl9mcm9udGVuZCBmYWlsZWQgKGVycm5v
ID0gJWQpXG4iLAorCQkJCQlkZXYtPm5hbWUsIHJlc3VsdCk7CisJCQlnb3RvIGZhaWxfZnJvbnRl
bmQ7CisJCX0KIAl9CiAKIAkvKiByZWdpc3RlciBkZW11eCBzdHVmZiAqLwpAQCAtMzQ5LDE5ICsz
NTIsMjMgQEAKIAkJZ290byBmYWlsX2ZlX2h3OwogCX0KIAotCWR2Yi0+ZmVfbWVtLnNvdXJjZSA9
IERNWF9NRU1PUllfRkU7Ci0JcmVzdWx0ID0gZHZiLT5kZW11eC5kbXguYWRkX2Zyb250ZW5kKCZk
dmItPmRlbXV4LmRteCwgJmR2Yi0+ZmVfbWVtKTsKLQlpZiAocmVzdWx0IDwgMCkgewotCQlwcmlu
dGsoS0VSTl9XQVJOSU5HICIlczogYWRkX2Zyb250ZW5kIGZhaWxlZCAoRE1YX01FTU9SWV9GRSwg
ZXJybm8gPSAlZClcbiIsCi0JCSAgICAgICBkZXYtPm5hbWUsIHJlc3VsdCk7Ci0JCWdvdG8gZmFp
bF9mZV9tZW07Ci0JfQorCWlmIChkZXYtPmhhc19mcm9udGVuZCkgeworCQlkdmItPmZlX21lbS5z
b3VyY2UgPSBETVhfTUVNT1JZX0ZFOworCQlyZXN1bHQgPSBkdmItPmRlbXV4LmRteC5hZGRfZnJv
bnRlbmQoJmR2Yi0+ZGVtdXguZG14LAorCQkJCQkJCSZkdmItPmZlX21lbSk7CisJCWlmIChyZXN1
bHQgPCAwKSB7CisJCQlwcmludGsoS0VSTl9XQVJOSU5HICIlczogYWRkX2Zyb250ZW5kIGZhaWxl
ZCAoRE1YX01FTU9SWV9GRSwgZXJybm8gPSAlZClcbiIsCisJCQkJCWRldi0+bmFtZSwgcmVzdWx0
KTsKKwkJCWdvdG8gZmFpbF9mZV9tZW07CisJCX0KIAotCXJlc3VsdCA9IGR2Yi0+ZGVtdXguZG14
LmNvbm5lY3RfZnJvbnRlbmQoJmR2Yi0+ZGVtdXguZG14LCAmZHZiLT5mZV9odyk7Ci0JaWYgKHJl
c3VsdCA8IDApIHsKLQkJcHJpbnRrKEtFUk5fV0FSTklORyAiJXM6IGNvbm5lY3RfZnJvbnRlbmQg
ZmFpbGVkIChlcnJubyA9ICVkKVxuIiwKLQkJICAgICAgIGRldi0+bmFtZSwgcmVzdWx0KTsKLQkJ
Z290byBmYWlsX2ZlX2Nvbm47CisJCXJlc3VsdCA9IGR2Yi0+ZGVtdXguZG14LmNvbm5lY3RfZnJv
bnRlbmQoJmR2Yi0+ZGVtdXguZG14LAorCQkJCQkJCQkmZHZiLT5mZV9odyk7CisJCWlmIChyZXN1
bHQgPCAwKSB7CisJCQlwcmludGsoS0VSTl9XQVJOSU5HICIlczogY29ubmVjdF9mcm9udGVuZCBm
YWlsZWQgKGVycm5vID0gJWQpXG4iLAorCQkJCQlkZXYtPm5hbWUsIHJlc3VsdCk7CisJCQlnb3Rv
IGZhaWxfZmVfY29ubjsKKwkJfQogCX0KIAogCS8qIHJlZ2lzdGVyIG5ldHdvcmsgYWRhcHRlciAq
LwpAQCAtMzY5LDE3ICszNzYsMjIgQEAKIAlyZXR1cm4gMDsKIAogZmFpbF9mZV9jb25uOgotCWR2
Yi0+ZGVtdXguZG14LnJlbW92ZV9mcm9udGVuZCgmZHZiLT5kZW11eC5kbXgsICZkdmItPmZlX21l
bSk7CisJaWYgKGRldi0+aGFzX2Zyb250ZW5kKQorCQlkdmItPmRlbXV4LmRteC5yZW1vdmVfZnJv
bnRlbmQoJmR2Yi0+ZGVtdXguZG14LCAmZHZiLT5mZV9tZW0pOwogZmFpbF9mZV9tZW06Ci0JZHZi
LT5kZW11eC5kbXgucmVtb3ZlX2Zyb250ZW5kKCZkdmItPmRlbXV4LmRteCwgJmR2Yi0+ZmVfaHcp
OworCWlmIChkZXYtPmhhc19mcm9udGVuZCkKKwkJZHZiLT5kZW11eC5kbXgucmVtb3ZlX2Zyb250
ZW5kKCZkdmItPmRlbXV4LmRteCwgJmR2Yi0+ZmVfaHcpOwogZmFpbF9mZV9odzoKIAlkdmJfZG14
ZGV2X3JlbGVhc2UoJmR2Yi0+ZG14ZGV2KTsKIGZhaWxfZG14ZGV2OgogCWR2Yl9kbXhfcmVsZWFz
ZSgmZHZiLT5kZW11eCk7CiBmYWlsX2RteDoKLQlkdmJfdW5yZWdpc3Rlcl9mcm9udGVuZChkdmIt
PmZyb250ZW5kKTsKKwlpZiAoZGV2LT5oYXNfZnJvbnRlbmQpCisJCWR2Yl91bnJlZ2lzdGVyX2Zy
b250ZW5kKGR2Yi0+ZnJvbnRlbmQpOwogZmFpbF9mcm9udGVuZDoKLQlkdmJfZnJvbnRlbmRfZGV0
YWNoKGR2Yi0+ZnJvbnRlbmQpOworCWlmIChkZXYtPmhhc19mcm9udGVuZCkKKwkJZHZiX2Zyb250
ZW5kX2RldGFjaChkdmItPmZyb250ZW5kKTsKKwogCWR2Yl91bnJlZ2lzdGVyX2FkYXB0ZXIoJmR2
Yi0+YWRhcHRlcik7CiBmYWlsX2FkYXB0ZXI6CiAJcmV0dXJuIHJlc3VsdDsKQEAgLTM4OCwxMiAr
NDAwLDE3IEBACiBzdGF0aWMgdm9pZCB1bnJlZ2lzdGVyX2R2YihzdHJ1Y3QgZW0yOHh4X2R2YiAq
ZHZiKQogewogCWR2Yl9uZXRfcmVsZWFzZSgmZHZiLT5uZXQpOwotCWR2Yi0+ZGVtdXguZG14LnJl
bW92ZV9mcm9udGVuZCgmZHZiLT5kZW11eC5kbXgsICZkdmItPmZlX21lbSk7Ci0JZHZiLT5kZW11
eC5kbXgucmVtb3ZlX2Zyb250ZW5kKCZkdmItPmRlbXV4LmRteCwgJmR2Yi0+ZmVfaHcpOworCWlm
IChkdmItPmZyb250ZW5kKSB7CisJCWR2Yi0+ZGVtdXguZG14LnJlbW92ZV9mcm9udGVuZCgmZHZi
LT5kZW11eC5kbXgsICZkdmItPmZlX21lbSk7CisJCWR2Yi0+ZGVtdXguZG14LnJlbW92ZV9mcm9u
dGVuZCgmZHZiLT5kZW11eC5kbXgsICZkdmItPmZlX2h3KTsKKwl9CiAJZHZiX2RteGRldl9yZWxl
YXNlKCZkdmItPmRteGRldik7CiAJZHZiX2RteF9yZWxlYXNlKCZkdmItPmRlbXV4KTsKLQlkdmJf
dW5yZWdpc3Rlcl9mcm9udGVuZChkdmItPmZyb250ZW5kKTsKLQlkdmJfZnJvbnRlbmRfZGV0YWNo
KGR2Yi0+ZnJvbnRlbmQpOworCWlmIChkdmItPmZyb250ZW5kKSB7CisJCWR2Yl91bnJlZ2lzdGVy
X2Zyb250ZW5kKGR2Yi0+ZnJvbnRlbmQpOworCQlkdmJfZnJvbnRlbmRfZGV0YWNoKGR2Yi0+ZnJv
bnRlbmQpOworCQlkdmItPmZyb250ZW5kID0gTlVMTDsKKwl9CiAJZHZiX3VucmVnaXN0ZXJfYWRh
cHRlcigmZHZiLT5hZGFwdGVyKTsKIH0KIApAQCAtNDAzLDggKzQyMCw5IEBACiAJaW50IHJlc3Vs
dCA9IDA7CiAJc3RydWN0IGVtMjh4eF9kdmIgKmR2YjsKIAotCWlmICghZGV2LT5ib2FyZC5oYXNf
ZHZiKSB7CisJaWYgKCFkZXYtPmJvYXJkLmhhc19kdmIgJiYgZGV2LT5oYXNfZHZiID09IDApIHsK
IAkJLyogVGhpcyBkZXZpY2UgZG9lcyBub3Qgc3VwcG9ydCB0aGUgZXh0ZW5zaW9uICovCisJCXBy
aW50ayhLRVJOX0lORk8gImVtMjh4eF9kdmI6IFRoaXMgZGV2aWNlIGRvZXMgbm90IHN1cHBvcnQg
dGhlIERWQiBleHRlbnNpb25cbiIpOwogCQlyZXR1cm4gMDsKIAl9CiAKQEAgLTQxNSw2ICs0MzMs
NyBAQAogCQlyZXR1cm4gLUVOT01FTTsKIAl9CiAJZGV2LT5kdmIgPSBkdmI7CisJZGV2LT5oYXNf
ZnJvbnRlbmQgPSAxOyAvKiBkZWZhdWx0aW5nIGZvciBvbGQgZGV2aWNlcyAqLwogCiAJZW0yOHh4
X3NldF9tb2RlKGRldiwgRU0yOFhYX0RJR0lUQUxfTU9ERSk7CiAJLyogaW5pdCBmcm9udGVuZCAq
LwpAQCAtNDY1LDIxICs0ODQsMjYgQEAKIAkJfQogCQlicmVhazsKICNlbmRpZgorCWNhc2UgRU0y
ODAwX0JPQVJEX1VOS05PV046CisJCWRldi0+aGFzX2Zyb250ZW5kID0gMDsKKwkJYnJlYWs7CiAJ
ZGVmYXVsdDoKIAkJcHJpbnRrKEtFUk5fRVJSICIlcy8yOiBUaGUgZnJvbnRlbmQgb2YgeW91ciBE
VkIvQVRTQyBjYXJkIgogCQkJCSIgaXNuJ3Qgc3VwcG9ydGVkIHlldFxuIiwKIAkJICAgICAgIGRl
di0+bmFtZSk7CiAJCWJyZWFrOwogCX0KLQlpZiAoTlVMTCA9PSBkdmItPmZyb250ZW5kKSB7CisJ
aWYgKE5VTEwgPT0gZHZiLT5mcm9udGVuZCAmJiBkZXYtPmhhc19mcm9udGVuZCA9PSAxKSB7CiAJ
CXByaW50ayhLRVJOX0VSUgogCQkgICAgICAgIiVzLzI6IGZyb250ZW5kIGluaXRpYWxpemF0aW9u
IGZhaWxlZFxuIiwKIAkJICAgICAgIGRldi0+bmFtZSk7CiAJCXJlc3VsdCA9IC1FSU5WQUw7CiAJ
CWdvdG8gb3V0X2ZyZWU7CiAJfQotCS8qIGRlZmluZSBnZW5lcmFsLXB1cnBvc2UgY2FsbGJhY2sg
cG9pbnRlciAqLwotCWR2Yi0+ZnJvbnRlbmQtPmNhbGxiYWNrID0gZW0yOHh4X3R1bmVyX2NhbGxi
YWNrOworCisJaWYgKGRldi0+aGFzX2Zyb250ZW5kKQorCQkvKiBkZWZpbmUgZ2VuZXJhbC1wdXJw
b3NlIGNhbGxiYWNrIHBvaW50ZXIgKi8KKwkJZHZiLT5mcm9udGVuZC0+Y2FsbGJhY2sgPSBlbTI4
eHhfdHVuZXJfY2FsbGJhY2s7CiAKIAkvKiByZWdpc3RlciBldmVyeXRoaW5nICovCiAJcmVzdWx0
ID0gcmVnaXN0ZXJfZHZiKGR2YiwgVEhJU19NT0RVTEUsIGRldiwgJmRldi0+dWRldi0+ZGV2KTsK
QEAgLTUwMCw3ICs1MjQsNyBAQAogCiBzdGF0aWMgaW50IGR2Yl9maW5pKHN0cnVjdCBlbTI4eHgg
KmRldikKIHsKLQlpZiAoIWRldi0+Ym9hcmQuaGFzX2R2YikgeworCWlmICghZGV2LT5ib2FyZC5o
YXNfZHZiICYmIGRldi0+aGFzX2R2YiA9PSAwKSB7CiAJCS8qIFRoaXMgZGV2aWNlIGRvZXMgbm90
IHN1cHBvcnQgdGhlIGV4dGVuc2lvbiAqLwogCQlyZXR1cm4gMDsKIAl9CmRpZmYgLXIgMzE1YmM0
YjY1YjRmIGxpbnV4L2RyaXZlcnMvbWVkaWEvdmlkZW8vZW0yOHh4L2VtMjh4eC5oCi0tLSBhL2xp
bnV4L2RyaXZlcnMvbWVkaWEvdmlkZW8vZW0yOHh4L2VtMjh4eC5oCVN1biBNYXkgMTcgMTI6Mjg6
NTUgMjAwOSArMDAwMAorKysgYi9saW51eC9kcml2ZXJzL21lZGlhL3ZpZGVvL2VtMjh4eC9lbTI4
eHguaAlTYXQgTWF5IDIzIDE3OjAzOjAwIDIwMDkgKzAyMDAKQEAgLTQyOSw2ICs0MjksMTEgQEAK
ICNkZWZpbmUgRU0yOFhYX0FVRElPICAgMHgxMAogI2RlZmluZSBFTTI4WFhfRFZCICAgICAweDIw
CiAKKyNkZWZpbmUgRU0yOFhYX0lOVEVSUlVQVF9FUAkweDgxCisjZGVmaW5lIEVNMjhYWF9BTkFM
T0dfVklERU9fRVAJMHg4MgorI2RlZmluZSBFTTI4WFhfQU5BTE9HX0FVRElPX0VQCTB4ODMKKyNk
ZWZpbmUgRU0yOFhYX0RJR0lUQUxUVl9FUAkweDg0CisKIHN0cnVjdCBlbTI4eHhfYXVkaW8gewog
CWNoYXIgbmFtZVs1MF07CiAJY2hhciAqdHJhbnNmZXJfYnVmZmVyW0VNMjhYWF9BVURJT19CVUZT
XTsKQEAgLTQ3OSw2ICs0ODQsMTMgQEAKIAl1bnNpZ25lZCBpbnQgc3RyZWFtX29uOjE7CS8qIExv
Y2tzIHN0cmVhbXMgKi8KIAl1bnNpZ25lZCBpbnQgaGFzX2F1ZGlvX2NsYXNzOjE7CiAJdW5zaWdu
ZWQgaW50IGhhc19hbHNhX2F1ZGlvOjE7CisJLyogc29tZSBkZXZpY2VzIGRvIG5vdCBoYXZlIGEg
ZnJvbnRlbmQsCisJICAgZWcgcmVhZGluZyBUUyBzdHJlYW0gb25seSBmcm9tIGFsdGVybmF0aXZl
CisJICAgc291cmNlcyBlZy4gbXBlZyBlbmNvZGVyIGRldmljZXMgKi8KKwl1bnNpZ25lZCBpbnQg
aGFzX2Zyb250ZW5kOjE7CisJLyogcHJpdmF0ZSBzZWN0aW9uLCBvbmx5IGlmIF90aGlzXyBib2Fy
ZCBzdXBwb3J0cyBtcGVnLXRzICovCisJdW5zaWduZWQgaW50IGhhc19kdmI6MTsKKwl1bnNpZ25l
ZCBpbnQgaGFzX2F0djoxOwogCiAJc3RydWN0IGVtMjh4eF9mbXQgKmZvcm1hdDsKIApAQCAtNTgw
LDYgKzU5Miw4IEBACiAJc3RydWN0IGRlbGF5ZWRfd29yayBzYnV0dG9uX3F1ZXJ5X3dvcms7CiAK
IAlzdHJ1Y3QgZW0yOHh4X2R2YiAqZHZiOworCisJdW5zaWduZWQgaW50IGxvY2tfY29udHJvbF9j
b21tYW5kczoxOwogfTsKIAogc3RydWN0IGVtMjh4eF9vcHMgewpAQCAtNjQ1LDcgKzY1OSw2IEBA
CiAKIC8qIFByb3ZpZGVkIGJ5IGVtMjh4eC1jYXJkcy5jICovCiBleHRlcm4gaW50IGVtMjgwMF92
YXJpYW50X2RldGVjdChzdHJ1Y3QgdXNiX2RldmljZSAqdWRldiwgaW50IG1vZGVsKTsKLWV4dGVy
biB2b2lkIGVtMjh4eF9wcmVfY2FyZF9zZXR1cChzdHJ1Y3QgZW0yOHh4ICpkZXYpOwogZXh0ZXJu
IHZvaWQgZW0yOHh4X2NhcmRfc2V0dXAoc3RydWN0IGVtMjh4eCAqZGV2KTsKIGV4dGVybiBzdHJ1
Y3QgZW0yOHh4X2JvYXJkIGVtMjh4eF9ib2FyZHNbXTsKIGV4dGVybiBzdHJ1Y3QgdXNiX2Rldmlj
ZV9pZCBlbTI4eHhfaWRfdGFibGVbXTsK
--0016e659fa66a808c8046a95b56c--
