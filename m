Return-path: <linux-media-owner@vger.kernel.org>
Received: from metis.ext.pengutronix.de ([85.220.165.71]:50559 "EHLO
        metis.ext.pengutronix.de" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1750779AbeCNN5f (ORCPT
        <rfc822;linux-media@vger.kernel.org>);
        Wed, 14 Mar 2018 09:57:35 -0400
Message-ID: <1521035853.4490.7.camel@pengutronix.de>
Subject: Re: [DE] Re: coda: i.MX6 decoding performance issues for
 multi-streaming
From: Philipp Zabel <p.zabel@pengutronix.de>
To: Javier Martin <javiermartin@by.com.es>,
        linux-media <linux-media@vger.kernel.org>
Date: Wed, 14 Mar 2018 14:57:33 +0100
In-Reply-To: <dfd0fe98-4e5e-bc28-c325-6c52f1964a03@by.com.es>
References: <c18549be-d55e-54d2-1524-1c51d05807ec@by.com.es>
         <1520940054.3965.10.camel@pengutronix.de>
         <dfd0fe98-4e5e-bc28-c325-6c52f1964a03@by.com.es>
Content-Type: text/plain; charset="UTF-8"
Mime-Version: 1.0
Content-Transfer-Encoding: 7bit
Sender: linux-media-owner@vger.kernel.org
List-ID: <linux-media.vger.kernel.org>

On Wed, 2018-03-14 at 13:05 +0100, Javier Martin wrote:
> Sorry everyone about my previous e-mail with all the HTML garbage. Here 
> is the plain text answer instead.
> 
> Hi Philipp,
> 
> thanks for your answer.
> 
> On 13/03/18 12:20, Philipp Zabel wrote:
>  > Hi Javier,
>  >
>  > On Mon, 2018-03-12 at 17:54 +0100, Javier Martin wrote:
>  >> Hi,
>  >> we have an i.MX6 Solo based board running the latest mainline kernel
>  >> (4.15.3).
>  >>
>  >> As part of our development we were measuring the decoding 
> performance of
>  >> the i.MX6 coda chip.
>  >>
>  >> For that purpose we are feeding the decoder with 640x368 @ 30fps H.264
>  >> streams that have been generated by another i.MX6 coda encoder
>  >> configured with fixed qp = 25 and gopsize = 16.

Those are the defaults. Is the encoder running on the same system, at
the same time? Or are you decoding a previously encoded stream (multiple
previously encoded streams)?

[...]
> I'm currently using 3.1.1 both for encoding and decoding. I think I got 
> it from the latest BSP provided by NXP. Now that you mention it the 
> driver is printing these messages at probe time which I had ignored so far:
> 
> coda 2040000.vpu: Firmware code revision: 46056
> coda 2040000.vpu: Initialized CODA960.
> coda 2040000.vpu: Unsupported firmware version: 3.1.1
> coda 2040000.vpu: codec registered as /dev/video[3-4]

That is strange, commit be7f1ab26f42 ("media: coda: mark CODA960
firmware versions 2.3.10 and 3.1.1 as supported") was merged
in v4.14.

> Do you think I should use an older version instead?

Unfortunately I have no indication that this would help.

> Also, do you think it would be worth trying different parameters in the 
> encoder to see how the decoder responds in those cases?

Possibly. It would be interesting to know if this happens more often for
low resolutions / low quality / static frames than high resolutions /
high quality / high movement.

I fear this may be some interaction between coda context switches and
bitstream reader unit state.

regards
Philipp
