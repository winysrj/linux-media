Return-path: <linux-media-owner@vger.kernel.org>
Received: from auth.a.painless.aa.net.uk ([90.155.4.51]:55235 "EHLO
	auth.a.painless.aa.net.uk" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1753052AbcFUAMK (ORCPT
	<rfc822;linux-media@vger.kernel.org>);
	Mon, 20 Jun 2016 20:12:10 -0400
Subject: Re: [PATCH v2 1/7] v4l: Correct the ordering of LSBs of the 10-bit
 raw packed formats
To: Hans Verkuil <hverkuil@xs4all.nl>,
	Sakari Ailus <sakari.ailus@linux.intel.com>,
	linux-media@vger.kernel.org
References: <1466439608-22890-1-git-send-email-sakari.ailus@linux.intel.com>
 <1466439608-22890-2-git-send-email-sakari.ailus@linux.intel.com>
 <576821D9.5090303@xs4all.nl>
From: Dave Stevenson <linux-media@destevenson.freeserve.co.uk>
Message-ID: <5768545E.4070706@destevenson.freeserve.co.uk>
Date: Mon, 20 Jun 2016 21:38:54 +0100
MIME-Version: 1.0
In-Reply-To: <576821D9.5090303@xs4all.nl>
Content-Type: text/plain; charset=windows-1252; format=flowed
Content-Transfer-Encoding: 7bit
Sender: linux-media-owner@vger.kernel.org
List-ID: <linux-media.vger.kernel.org>

Hi Hans.

On 20/06/16 18:03, Hans Verkuil wrote:
> On 06/20/2016 06:20 PM, Sakari Ailus wrote:
>> The 10-bit packed raw bayer format documented that the data of the first
>> pixel of a four-pixel group was found in the first byte and the two
>> highest bits of the fifth byte. This was not entirely correct. The two
>> bits in the fifth byte are the two lowest bits. The second pixel occupies
>> the second byte and third and fourth least significant bits and so on.
>>
>> Signed-off-by: Sakari Ailus <sakari.ailus@linux.intel.com>
> As mentioned, this needs confirmation. I wonder, isn't this specified in the UVC
> spec?
>
> Regards,
>
> 	Hans
I'm assuming this is intended to be the same format as generated by many 
Bayer sensors.
Those are defined in both the SMIA CCP2 (section 7.9), and MIPI CSI2 
(section 11.4.4) specs. Whilst nominally restricted, they are both 
available via unofficial websites if you Google for them (I'm happy to 
send links, but didn't want to break mailing list rules by just posting 
them).
CSI2 draft spec Figure 98 "RAW10 Data Transmission on CSI-2 Bus Bitwise 
Illustration" is probably the clearest confirmation of the bit ordering.

dcraw from http://www.cybercom.net/~dcoffin/dcraw/ can consume Raw10 via 
nokia_load_raw
     for (dp=data, col=0; col < raw_width; dp+=5, col+=4)
       FORC4 RAW(row,col+c) = (dp[c] << 2) | (dp[4] >> (c << 1) & 3);

And checking against the Raspberry Pi hardware simulator, the RAW10 
parser code has
             for (i = 0; i < width; i++) {
                switch ((i + tile_x) & 3) {
                   case 0:  val = (buf[0] << 2) | (buf[4] & 3); break;
                   case 1:  val = (buf[1] << 2) | ((buf[4] >> 2) & 3); 
break;
                   case 2:  val = (buf[2] << 2) | ((buf[4] >> 4) & 3); 
break;
                   default: val = (buf[3] << 2) | ((buf[4] >> 6) & 3);


All of those agree with Sakari's update that the first pixel's LSBits 
are in bits 1..0 of byte 5, 2nd pixel in bits 3..2, etc.

Regards,
   Dave
(working on the Pi CSI2 receiver V4L2 driver as there is now sufficient 
data in the public domain to do it. I'll be wanting these formats!)
